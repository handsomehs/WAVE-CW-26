apiVersion: batch/v1
kind: Job
metadata:
  generateName: awave-ncu-
  labels:
    kueue.x-k8s.io/queue-name: eidf018ns-profiling-queue
spec:
  completions: 1
  backoffLimit: 1
  ttlSecondsAfterFinished: 1800
  template:
    metadata:
      name: awave-pod
    spec:
      activeDeadlineSeconds: 1200
      containers:
      - name: run
        image: $container
        env:
          - name: HOME
            value: $shared_pvc_remote
          # Keep the NCU run focused on CUDA kernels (OpenMP can be profiled with nsys).
          - name: OMP_TARGET_OFFLOAD
            value: DISABLED
        command:
          - bash
          - -lc
          - >-
            ncu -o awave-ncu-$(date +%Y%m%d-%H%M%S) -f
            --target-processes all
            --kernel-name regex:step_kernel_interior
            --launch-skip 1 --launch-count 1
            --section SpeedOfLight_RooflineChart
            build-dev/awave -shape 256,256,256 -nsteps 4 -out_period 4 /tmp/awave-profile
        resources:
          requests:
            cpu: 1
            memory: 8Gi
            nvidia.com/gpu: 1
          limits:
            cpu: 1
            memory: 8Gi
            nvidia.com/gpu: 1
      restartPolicy: Never
      nodeSelector:
        nvidia.com/gpu.product: NVIDIA-A100-SXM4-40GB
